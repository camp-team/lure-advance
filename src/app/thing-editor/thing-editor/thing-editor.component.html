<div class="container" *ngIf="thing$ | async as thing">
  <h1>「{{ form.value.title }}」を編集</h1>
  <label class="file">
    <input
      class="file__input"
      (change)="selectFiles($event)"
      #file_input
      type="file"
      multiple
      accept=".jpeg, .jpg, .png, .stl "
    />
    <mat-icon class="file__icon" inline>backup</mat-icon>
    <button
      type="button"
      class="file__up-btn"
      [disabled]="images.length >= MAX_FILE_LENGTH"
      (click)="file_input.click()"
      mat-flat-button
      autocomplete="off"
      color="primary"
    >
      ファイルを選択する
    </button>
  </label>

  <p *ngIf="images.length">Image</p>
  <div class="grid">
    <div
      class="upload upload--image"
      *ngFor="let file of images; index as i"
      [style.background-image]="'url(' + file + ')'"
    >
      <button (click)="deleteImage(i)" class="upload__del-btn">
        <mat-icon class="upload__del-icon" inline> delete</mat-icon>
      </button>
    </div>
  </div>

  <p *ngIf="stls.length">STL</p>
  <div class="grid">
    <div *ngFor="let stl of stls; index as i">
      <button (click)="deleteStl(i)" class="upload__del-btn">
        <mat-icon class="upload__del-icon" inline>delete</mat-icon>
      </button>
      <stl-model-viewer
        class="upload upload--stl"
        [stlModels]="[stl]"
      ></stl-model-viewer>
    </div>
  </div>

  <p>詳細</p>
  <form [formGroup]="form" class="details" (ngSubmit)="save(thing)">
    <mat-form-field appearance="outline">
      <mat-label>タイトル</mat-label>
      <input matInput autocomplete="off" #input formControlName="title" />
      <mat-hint align="end">{{ input.value.length }}/100</mat-hint>
      <mat-error *ngIf="titleControl.hasError('maxlength')"
        >長過ぎます</mat-error
      >
      <mat-error *ngIf="titleControl.hasError('required')"
        >必須入力です</mat-error
      >
    </mat-form-field>
    <mat-form-field appearance="outline">
      <mat-label>説明</mat-label>
      <textarea
        matInput
        formControlName="description"
        #textarea
        autocomplete="off"
        matTextareaAutosize
        [value]="thing.description"
      >
      </textarea>
      <mat-hint align="end">{{ textarea.value.length }}/5000</mat-hint>
      <mat-error *ngIf="descriptionControl.hasError('maxlength')"
        >長過ぎます</mat-error
      >
    </mat-form-field>
    <div *ngIf="categories" class="categories" [formGroup]="categoriesForm">
      <p>CATEGORIES</p>
      <mat-checkbox
        *ngFor="let category of categories"
        [formControlName]="category.value"
        class="categories__check"
        >{{ category.name }}
      </mat-checkbox>
    </div>
    <mat-form-field>
      <mat-label>タグ</mat-label>
      <mat-chip-list #chipList aria-label="tag selection">
        <mat-chip
          *ngFor="let tag of tags"
          [selectable]="selectable"
          [removable]="removable"
          (removed)="remove(tag)"
        >
          {{ tag }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        <input
          placeholder="New tag..."
          [matChipInputFor]="chipList"
          [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
          [matChipInputAddOnBlur]="addOnBlur"
          (matChipInputTokenEnd)="add($event)"
          autocomplete="off"
          formControlName="tags"
        />
      </mat-chip-list>
    </mat-form-field>
    <div class="details__actions">
      <button (click)="cancel(thing)" mat-button>キャンセル</button>
      <button [disabled]="form.invalid" mat-flat-button color="primary">
        保存
      </button>
    </div>
  </form>
</div>
